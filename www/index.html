<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Close Loop CRM</title>
    <link rel="stylesheet" href="style.css">



</head>
<body>

    <div id="splash-screen">
    <div class="splash-content">
        <div class="main-logo">
            <img src="assets/closed-loop-logo10.png" alt="Closed Loop" class="splash-logo-img">
        </div>
        <div class="loading-bar-container">
            <div class="loading-bar-progress"></div>
        </div>
    </div>
</div>

    <div id="side-menu" class="side-menu">
    <div class="side-menu-brand">
        <img src="assets/closed-loop-logo10.png" alt="Logo" class="side-menu-logo">
    </div>
    
    <nav class="menu-items">
        <a href="#" onclick="showScreen('pipeline-screen'); toggleMenu();">Pipeline</a>
        <a href="#" onclick="showScreen('tasks-screen'); toggleMenu();">All Tasks</a>
        <a href="#" onclick="showScreen('roi-screen'); toggleMenu();">ROI Dashboard</a>
        <a href="#" onclick="showScreen('settings-screen'); toggleMenu();">Settings</a>
    </nav>
</div>

    <div id="menu-overlay" class="menu-overlay" onclick="toggleMenu()"></div>

    <section id="pipeline-screen" class="screen">
        <header class="teal-header">
    <div class="header-top" style="display: flex; justify-content: space-between; align-items: center; height: 60px;">
    <button onclick="openCalendar()" style="background:none; border:none; color:white; cursor:pointer; padding:5px; display: flex; align-items: center;">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.0" stroke-linecap="square">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
    </button>

    <div style="display: flex; align-items: center; gap: 15px;">
        <button onclick="toggleNotifications()" style="background:none; border:none; color:white; cursor:pointer; padding:5px; position: relative;">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="square">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
            <span id="notif-badge" style="display:none; position: absolute; top: -2px; right: -2px; background: #ff3b30; color: white; font-size: 10px; padding: 2px 5px; border-radius: 10px; border: 2px solid var(--teal-primary);">0</span>
        </button>

        <button onclick="toggleSearch(true)" style="background:none; border:none; color:white; cursor:pointer; padding:5px;">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="square">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
        </button>
        <div class="user-profile-mini user-initials-display" onclick="openProfilePage()" style="cursor:pointer;">JS</div>
    </div>
</div>

    <div class="page-identity">
        <h2 id="current-screen-title">Pipeline</h2>
    </div>
    <div class="stage-tabs">
    <button class="tab active" onclick="filterLeads('New', this)">New</button>
    <button class="tab" onclick="filterLeads('In-Progress', this)">In-Progress</button>
    <button class="tab" onclick="filterLeads('Won', this)">Won</button>
</div>

</header>

        <main class="content">
            <div id="leads-container"></div>
        </main>
    </section>

    <section id="profile-screen" class="screen" style="display: none;">
        <header class="teal-header" style="min-height: 100px; display: flex; flex-direction: column; justify-content: space-between;">
    <div class="header-top" style="display: flex; justify-content: space-between; align-items: center;">
        <button class="menu-btn" onclick="showScreen('pipeline-screen')" style="display: flex; align-items: center; justify-content: center;">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="square" stroke-linejoin="miter">
        <path d="M19 12H5M11 18l-6-6 6-6"/>
    </svg>
</button>
        <div class="user-profile-mini user-initials-display" onclick="openProfilePage()" style="cursor:pointer;">JS</div>
    </div>

    <div class="page-identity" style="padding-bottom: 10px;">
        <h2 class="screen-title-tag" style="margin: 0; font-size: 14px; color: rgba(255,255,255,0.85); font-weight: 600; text-transform: none;">
            Lead Details
        </h2>
    </div>
</header>
        
        <main class="content">
            <div class="profile-card">
                <h1 id="profile-main-name">Loading...</h1>
                <p id="profile-sub-info" style="color: #666; margin-top: -10px;">Source • Value</p>
                <div class="action-grid">
                    <button class="action-btn" onclick="logActivity('Call')">Call</button>
                    <button class="action-btn" onclick="logActivity('WhatsApp')">WhatsApp</button>
                    <button class="action-btn" onclick="logActivity('Email')">Email</button>
                    <button class="action-btn" onclick="logActivity('Text')">Text</button>
                </div>
            </div>

            <div class="details-list">
                <div class="detail-item">
                    <label>Company</label>
                    <input type="text" id="profile-company-input" class="profile-edit-input" placeholder="Enter company name..." onchange="syncProfileToData()">
                </div>
                <div class="detail-item">
                    <label>Phone</label>
                    <input type="tel" id="profile-phone-input" class="profile-edit-input" oninput="validateLive(this, 'phone')" onchange="syncProfileToData()">
                </div>
                <div class="detail-item">
                    <label>Email</label>
                    <input type="email" id="profile-email-input" class="profile-edit-input" oninput="validateLive(this, 'email')" onchange="syncProfileToData()">
                </div>
                <div class="detail-item">
                    <label>Address</label>
                    <input type="text" id="profile-address-input" class="profile-edit-input" placeholder="Enter address..." onchange="syncProfileToData()">
                </div>
            </div>

            <div class="profile-card" style="margin-top: 20px; text-align: left;">
    <h3 style="font-size: 14px; margin: 0 0 12px 0; color: var(--teal-primary); text-transform: uppercase; letter-spacing: 1px;">Schedule Task</h3>
    
    <input type="text" id="task-desc" placeholder="What needs to be done?" style="margin-bottom: 10px;">
    
    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
        <input type="date" id="task-date" style="margin: 0; flex: 1;">
        <input type="time" id="task-time" style="margin: 0; flex: 1;">
    </div>

    <div class="info-group">
        <label style="font-size: 11px; color: #999; font-weight: bold;">Set Reminder</label>
        <select id="task-reminder-offset" style="margin-bottom: 10px;">
            <option value="none">No Reminder</option>
            <option value="0">At time of task</option>
            <option value="10">10 mins before</option>
            <option value="60">1 hour before</option>
            <option value="1440">1 day before</option>
        </select>
    </div>
    
    <button onclick="saveTask()" class="save-btn" style="padding: 12px;">Set Task</button>
</div>

            <div class="profile-card" style="margin-top: 20px; text-align: left;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
        <h3 style="font-size: 14px; margin: 0; color: var(--teal-primary); text-transform: uppercase; letter-spacing: 1px;">Add Note</h3>
        
        <button onclick="saveNoteToActivity()" style="background: var(--teal-primary); border: none; border-radius: 8px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        </button>
    </div>
    
    <textarea id="profile-notes-input" placeholder="Type a note and tap the + icon to save..." style="width: 100%; min-height: 80px; border: 1px solid #eee; border-radius: 12px; padding: 15px; font-family: inherit; font-size: 14px; resize: none; background: #fafafa; display: block; box-sizing: border-box;"></textarea>
</div>

            <div class="details-list" style="margin-top: 20px;">
                <h3 style="font-size: 14px; margin-bottom: 15px; color: var(--teal-primary); text-transform: uppercase; letter-spacing: 1px;">Activity History</h3>
                <div id="activity-log" class="timeline"></div>
            </div>
        </main>
    </section>

    <section id="tasks-screen" class="screen" style="display: none;">
    <header class="teal-header" style="min-height: 100px;">
        <div class="header-top" style="display: flex; justify-content: space-between; align-items: center;">
            <button class="menu-btn" onclick="showScreen('pipeline-screen')" style="display: flex; align-items: center; justify-content: center;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="square">
                    <path d="M19 12H5M11 18l-6-6 6-6"/>
                </svg>
            </button>
            <div class="user-profile-mini user-initials-display" onclick="openProfilePage()" style="cursor:pointer;">JS</div>
        </div>
        <div class="page-identity" style="padding-bottom: 10px;">
            <h2 class="screen-title-tag" style="margin: 0; font-size: 14px; color: rgba(255,255,255,0.85); font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">
                All Tasks
            </h2>
        </div>
    </header>

    <main class="content">
        <div id="all-tasks-container">
            </div>
    </main>
</section>

    <div id="lead-detail-screen" class="modal-overlay" onclick="handleBackdropClick(event)" style="display: none;">
        <div class="lead-detail-card" onclick="event.stopPropagation()">
            <div style="width: 40px; height: 5px; background: #e0e0e0; border-radius: 10px; margin: -15px auto 20px;"></div>

            <div class="detail-header">
                <h2 id="detail-name" style="margin-bottom: 25px;">Lead Name</h2>
            </div>

            <div class="detail-body">
                <div class="info-group">
                    <label>Company Name</label>
                    <input type="text" id="detail-company-input" placeholder="Add company..." onchange="updateLeadContact()">
                </div>

                <div class="info-group">
                    <label>Phone Number</label>
                    <input type="tel" id="detail-phone-input" placeholder="Add phone..." oninput="validateLive(this, 'phone')" onchange="updateLeadContact()">
                </div>

                <div class="info-group">
                    <label>Email Address</label>
                    <input type="email" id="detail-email-input" placeholder="Add email..." oninput="validateLive(this, 'email')" onchange="updateLeadContact()">
                </div>

                <div class="info-group">
                    <label>Pipeline Stage</label>
                    <select id="detail-status-select" onchange="updateLeadStatus()">
                        <option value="New">New</option>
                        <option value="In-Progress">In-Progress</option>
                        <option value="Won">Won</option>
                    </select>
                </div>
                
                <button class="save-btn" onclick="openFullProfile()" style="margin-top: 10px;">Activity & Contact</button>
            </div>
        </div>
    </div>
    
    <div id="roi-screen" class="screen" style="display:none;">
    <header class="teal-header">
        <div class="header-top">
            <button onclick="toggleMenu()" class="menu-btn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
            <div class="user-initials-display">JS</div>
        </div>
        <div class="page-identity">
            <h1 style="margin: 0; font-size: 14px; color: rgba(255, 255, 255, 0.85); text-transform: none; letter-spacing: 1px; font-weight: 700;">Performance ROI</h1>
        </div>
    </header>

    <main class="content">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div class="roi-stat-card">
                <small>Total Pipeline</small>
                <h2 id="roi-pipeline-total">£0</h2>
            </div>
            <div class="roi-stat-card" style="border-top: 4px solid #4caf50;">
                <small>Closed Revenue</small>
                <h2 id="roi-revenue-total">£0</h2>
            </div>
        </div>

        <div class="roi-chart-card">
            <h3>Win Rate</h3>
            <div id="roi-win-rate" style="font-size: 32px; font-weight: 800; color: var(--teal-primary);">0%</div>
            <p style="font-size: 12px; color: #666;">of leads successfully closed</p>
        </div>

        <div class="roi-chart-card">
            <h3>Revenue by Source</h3>
            <div id="roi-source-list">
                </div>
        </div>
    </main>
</div>

    <section id="settings-screen" class="screen" style="display: none;">
    </section>

    <div id="add-lead-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header"><h2>Add New Lead</h2><button onclick="closeModal()" class="close-btn">✕</button></div>
            <form id="lead-form">
                <input type="text" id="lead-name" placeholder="Lead Name" required>
                <input type="text" id="lead-company" placeholder="Company Name">
                <input type="text" id="lead-source" placeholder="Source" required>
                <input type="number" id="lead-value" placeholder="Value (£)" required>
                <input type="text" id="lead-phone" placeholder="Phone Number" required>
                <input type="text" id="lead-email" placeholder="Email Address" required>
                <button type="submit" class="save-btn">Save Lead</button>
            </form>
        </div>
    </div>

    <div id="delete-modal" class="modal-overlay" style="display: none; align-items: center; justify-content: center;">
        <div class="modal-content" style="width: 85%; border-radius: 20px; padding: 25px; text-align: center;">
            <div style="background: #ffebee; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
                <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="#ff3b30" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            </div>
            <h3 style="margin: 0 0 10px 0;">Delete Lead?</h3>
            <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button onclick="closeDeleteModal()" style="flex: 1; padding: 15px; border-radius: 12px; border: 1px solid #ddd; background: white; font-weight: 600;">Cancel</button>
                <button id="confirm-delete-btn" style="flex: 1; padding: 15px; border-radius: 12px; border: none; background: #ff3b30; color: white; font-weight: 600;">Delete</button>
            </div>
        </div>
    </div>

    <div id="validation-modal" class="modal-overlay" style="display: none; align-items: center; justify-content: center;">
    <div class="modal-content" style="width: 85%; border-radius: 20px; padding: 25px; text-align: center;">
        <div style="background: #fff3e0; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
            <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="#ff9800" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
        </div>
        <h3 style="margin: 0 0 10px 0;">Check Details</h3>
        <p id="validation-error-msg" style="color: #666; font-size: 14px;">Please ensure the phone number and email are in the correct format.</p>
        <button onclick="closeValidationModal()" style="margin-top: 20px; width: 100%; padding: 15px; border-radius: 12px; border: none; background: var(--teal-primary); color: white; font-weight: 600;">Got it</button>
    </div>
</div>

<div id="notif-modal" class="modal-overlay" style="display:none; align-items: center; justify-content: center; z-index: 6000;">
    <div class="modal-content" style="width: 90%; max-height: 80vh; overflow-y: auto;">
        <h3 style="color: var(--teal-primary);">Notifications</h3>
        <div id="notif-list-container">
            </div>
        <button class="save-btn" onclick="toggleNotifications()" style="margin-top:15px;">Close</button>
    </div>
</div>

<div id="search-overlay" class="search-overlay" style="display:none;">
    <div class="search-header">
        <input type="text" id="search-input" placeholder="Search leads by name..." oninput="handleSearch(this.value)">
        <button onclick="toggleSearch(false)" class="close-search">Cancel</button>
    </div>
    <div id="search-results" class="search-results-container">
        </div>
</div>

<nav class="bottom-nav">
    <button class="nav-item" onclick="toggleMenu()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.0" stroke-linecap="square">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
    </button>

    <button class="nav-item" onclick="showScreen('pipeline-screen')">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.0" stroke-linecap="square">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
        </svg>
    </button>
    
    <button class="nav-item" onclick="openModal()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.0" stroke-linecap="square">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
    </button>
</nav>

<div id="calendar-modal" class="modal-overlay" style="display:none; align-items: center; justify-content: center; background: rgba(0,0,0,0.8);">
    <div class="calendar-container">
        <div class="calendar-header">
            <button onclick="changeMonth(-1)">&#10094;</button>
            <h2 id="calendar-month-year">Month Year</h2>
            <button onclick="changeMonth(1)">&#10095;</button>
        </div>
        <div class="calendar-weekdays">
            <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
        </div>
        <div id="calendar-days" class="calendar-days"></div>
        <button class="save-btn" style="margin-top: 15px;" onclick="closeCalendar()">Close</button>
    </div>
</div>

<div id="toast-notification" class="toast" style="display:none;">
    <div class="toast-content">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>
        <span id="toast-message">Task Scheduled!</span>
    </div>
</div>

<div id="calendar-task-modal" class="modal-overlay" style="display:none; align-items: center; justify-content: center; z-index: 9999;" onclick="closeCalendarTaskModal(event)">
    <div class="modal-content" style="width: 85%; border-radius: 20px;">
        <h3 id="calendar-modal-date">Tasks</h3>
        <div id="calendar-task-list"></div>
        <button class="save-btn" onclick="document.getElementById('calendar-task-modal').style.display='none'">Close</button>
    </div>
</div>

    

    <div id="auth-screen" class="screen" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#fff; z-index:10000; display:flex; flex-direction:column; padding:30px; box-sizing:border-box;">
    <div style="margin-top: auto; margin-bottom: auto;">
        <div style="text-align:center; margin-bottom:30px;">
            <div style="width:70px; height:70px; background:var(--teal-primary); border-radius:18px; margin:0 auto 15px; display:flex; align-items:center; justify-content:center;">
                <svg width="35" height="35" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
            </div>
            <h1 id="auth-title" style="color:var(--text-dark); margin:0; font-size:26px;">Create Account</h1>
            <p id="auth-subtitle" style="color:#888; margin-top:5px;">Set up your secure CRM access</p>
        </div>

        <div id="auth-name-fields">
            <input type="text" id="auth-first-name" placeholder="First Name" 
                   style="width:100%; padding:16px; margin-bottom:12px; border:1px solid #eee; border-radius:12px; background:#f9f9f9; font-size:16px; outline:none;">
            <input type="text" id="auth-last-name" placeholder="Last Name" 
                   style="width:100%; padding:16px; margin-bottom:12px; border:1px solid #eee; border-radius:12px; background:#f9f9f9; font-size:16px; outline:none;">
        </div>

        <input type="text" id="auth-username" 
               inputmode="email" 
               placeholder="Email" 
               style="width:100%; padding:16px; margin-bottom:12px; border:1px solid #eee; border-radius:12px; background:#f9f9f9; font-size:16px; outline:none;">
        
        <input type="password" id="auth-password" placeholder="Password" 
               style="width:100%; padding:16px; margin-bottom:8px; border:1px solid #eee; border-radius:12px; background:#f9f9f9; font-size:16px; outline:none;">
        
        <div id="forgot-password-area" style="text-align: right; margin-bottom: 20px; display: none;">
            <a href="javascript:void(0)" onclick="handleForgotPassword()" style="color: #999; font-size: 12px; text-decoration: none;">Forgot Password?</a>
        </div>
        
        <button id="auth-button" onclick="handleAuthAction()" 
                style="width:100%; padding:18px; background:var(--teal-primary); color:white; border:none; border-radius:12px; font-size:16px; font-weight:700; transition: 0.3s; margin-top: 10px;">
            Sign Up
        </button>
        
        <p style="text-align:center; margin-top:20px; font-size:14px; color:#666;">
            <span id="auth-toggle-text">Already have an account?</span> 
            <a href="javascript:void(0)" onclick="toggleAuthMode()" id="auth-toggle-link" style="color:var(--teal-primary); font-weight:700; text-decoration:none;">Log In</a>
        </p>

        <p id="auth-error" style="color:#ff4d4d; text-align:center; margin-top:15px; font-size:13px; display:none;"></p>
    </div>
</div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script src="capacitor.js"></script>

    <script src="script.js"></script>

</body>
</html>